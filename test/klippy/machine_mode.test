# Machine Mode Comprehensive Test Suite
# Tests: Machine modes (3D Printer, CNC Spindle, CNC Laser)
# Tests: 3-axis, 4-axis, 5-axis, 6-axis configurations
# Tests: Homing, Movement, Spindle/Laser control, Probing

DICTIONARY atmega644p.dict
CONFIG machine_mode.cfg

# ========================================================================
# TEST 1: INITIALIZATION & MODE CHECKS
# ========================================================================

# Check initial machine mode (should be CNC)
GET_MACHINE_MODE

# Check available axes (should show XYZABC - 6 axis)
GET_POSITION

# ========================================================================
# TEST 2: 3-AXIS HOMING (XYZ)
# ========================================================================

# Home all linear axes
G28 X Y Z

# Verify positions after homing
GET_POSITION

# Move to safe position
G90
G1 X50 Y50 Z100 F3000

# ========================================================================
# TEST 3: 4-AXIS OPERATION (XYZA)
# ========================================================================

# Home A axis
G28 A

# 4-axis coordinated move
G1 X100 Y100 Z50 A45 F2000

# Verify position includes A
GET_POSITION

# A-axis rotation test
G1 A90 F1000
G1 A180 F1000
G1 A0 F1000

# ========================================================================
# TEST 4: 5-AXIS OPERATION (XYZAB)
# ========================================================================

# Home B axis
G28 B

# 5-axis coordinated move
G1 X150 Y100 Z75 A30 B45 F1500

# Verify position includes A and B
GET_POSITION

# B-axis rotation test
G1 B90 F800
G1 B-45 F800
G1 B0 F800

# ========================================================================
# TEST 5: 6-AXIS OPERATION (XYZABC)
# ========================================================================

# Home C axis
G28 C

# 6-axis coordinated move
G1 X200 Y150 Z100 A60 B30 C90 F1000

# Verify all axes
GET_POSITION

# Full 6-axis coordinated movement
G1 X100 Y100 Z50 A45 B-30 C180 F1200

# Individual axis moves
G1 A0 F500
G1 B0 F500
G1 C0 F500

# ========================================================================
# TEST 6: CNC MODE - SPINDLE CONTROL
# ========================================================================

# Ensure we're in CNC mode with spindle
SET_MACHINE_MODE MODE=cnc TOOL_MODE=spindle

# M3: Start spindle clockwise at 12000 RPM
M3 S12000
GET_MACHINE_MODE

# Dwell for spindle ramp-up
G4 P2

# Movement with spindle running
G1 X50 Y50 F1000

# M4: Start spindle counterclockwise at 8000 RPM
M4 S8000
G4 P1

# M5: Stop spindle
M5

# Verify spindle stopped
GET_MACHINE_MODE

# ========================================================================
# TEST 7: CNC MODE - LASER CONTROL
# ========================================================================

# Switch to laser mode
SET_MACHINE_MODE MODE=cnc TOOL_MODE=laser

# M3: Start laser at 50% power
M3 S50
GET_MACHINE_MODE

# Laser cutting move
G1 X100 Y100 F500

# M4: Dynamic laser power (50%)
M4 S50
G1 X150 Y150 F500

# M5: Stop laser
M5

# Verify laser stopped
GET_MACHINE_MODE

# ========================================================================
# TEST 8: 3D PRINTER MODE
# ========================================================================

# Switch to 3D printer mode
SET_MACHINE_MODE MODE=3d_print

# Verify mode change
GET_MACHINE_MODE

# Set extruder position
SET_KINEMATIC_POSITION E=0

# Extrusion test
G1 E5 F100
G1 E-2 F100

# Print move (XYZ + E)
G1 X50 Y50 Z1 E10 F1000
G1 X100 Y50 Z1 E15 F1000

# Verify position includes extruder
GET_POSITION

# ========================================================================
# TEST 9: CNC PROBING - 3-AXIS (XYZ)
# ========================================================================

# Return to CNC mode
SET_MACHINE_MODE MODE=cnc TOOL_MODE=spindle

# Move to probe start position
G90
G1 X10 Y10 Z50 F2000

# G38.2: Probe toward workpiece (Z-axis)
G38.2 Z0 F100

# Verify probe result
GET_POSITION

# Retract after probe
G1 Z50 F500

# G38.2: Probe in X direction
G1 X10 Y50 Z20
G38.2 X100 F100

# Retract
G1 X10 F500

# ========================================================================
# TEST 10: CNC PROBING - 6-AXIS (XYZABC)
# ========================================================================

# Move to probe position with rotary axes
G1 X50 Y50 Z50 A0 B0 C0 F1000

# Probe with A-axis rotation
G38.2 Z10 A45 F50

# Verify multi-axis probe result
GET_POSITION

# ========================================================================
# TEST 11: MODAL STATE MANAGEMENT (M70-M73)
# ========================================================================

# Start spindle at specific speed
M3 S10000

# M70: Save current modal state
M70

# Change spindle speed
M3 S15000

# M72: Restore saved state (should restore S10000)
M72

# Stop spindle
M5

# ========================================================================
# TEST 12: AUTO-RESTORE WITH M73/M99
# ========================================================================

# Start spindle
M3 S8000

# M73: Save with auto-restore
M73

# Simulate subroutine: change spindle
M3 S20000

# M99: Return from subroutine (auto-restores S8000)
M99

# Stop spindle
M5

# ========================================================================
# TEST 13: HOMING ALL AXES
# ========================================================================

# Home all 6 axes at once
G28

# Verify all axes homed
GET_POSITION

# ========================================================================
# TEST 14: MODE SWITCHING STRESS TEST
# ========================================================================

# Rapid mode switching
SET_MACHINE_MODE MODE=cnc TOOL_MODE=spindle
M3 S12000
M5

SET_MACHINE_MODE MODE=cnc TOOL_MODE=laser
M3 S75
M5

SET_MACHINE_MODE MODE=3d_print
SET_KINEMATIC_POSITION E=0
G1 E2 F50

SET_MACHINE_MODE MODE=cnc TOOL_MODE=spindle

# ========================================================================
# TEST 15: COORDINATED 6-AXIS MOVES
# ========================================================================

# Complex 6-axis toolpath
G90
G1 X100 Y100 Z50 A0 B0 C0 F2000
G1 X150 Y100 Z50 A30 B15 C45 F1500
G1 X150 Y150 Z50 A60 B30 C90 F1500
G1 X100 Y150 Z50 A90 B45 C135 F1500
G1 X100 Y100 Z50 A120 B60 C180 F1500

# Circular interpolation with rotation
G2 X150 Y150 I25 J25 A180 F1000
G2 X100 Y100 I-25 J-25 A0 F1000

# ========================================================================
# TEST 16: POSITION REPORTING - ALL MODES
# ========================================================================

# CNC mode position
SET_MACHINE_MODE MODE=cnc TOOL_MODE=spindle
G1 X50 Y50 Z50 A30 B30 C30 F1000
GET_POSITION

# 3D print mode position
SET_MACHINE_MODE MODE=3d_print
SET_KINEMATIC_POSITION E=0
G1 X100 Y100 Z10 E5 F800
GET_POSITION

# Return to CNC mode
SET_MACHINE_MODE MODE=cnc TOOL_MODE=spindle

# ========================================================================
# TEST 17: FINAL HOME AND PARK
# ========================================================================

# Home all axes
G28

# Park position
G90
G1 X0 Y0 Z150 A0 B0 C0 F3000

# Final position check
GET_POSITION

# Final mode check
GET_MACHINE_MODE

# Test complete
M5
