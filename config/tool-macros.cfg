# Tool Management Macros
# High-level G-Code Macros für einfache Tool-Verwaltung
#
# Diese Datei enthält vorgefertigte Macros für häufige Tool-Operationen

#####################################################################
# TOOL SETUP MACROS
#####################################################################

[gcode_macro ADD_DRILL]
description: Füge einen Bohrer zur Tool-Datenbank hinzu
gcode:
    {% set id = params.ID|int %}
    {% set name = params.NAME|default("Drill " ~ id) %}
    {% set diameter = params.DIAMETER|float %}
    {% set length = params.LENGTH|float %}
    {% set flute_length = params.FLUTE_LENGTH|default(length * 0.5)|float %}
    {% set max_rpm = params.MAX_RPM|default(10000)|int %}
    {% set feedrate = params.FEEDRATE|default(300)|float %}
    {% set plunge_rate = params.PLUNGE_RATE|default(100)|float %}
    
    ADD_TOOL ID={id} NAME="{name}" TYPE=drill DIAMETER={diameter} LENGTH={length} FLUTE_LENGTH={flute_length} MAX_RPM={max_rpm} FEEDRATE={feedrate} PLUNGE_RATE={plunge_rate}

[gcode_macro ADD_ENDMILL]
description: Füge einen Schaftfräser zur Tool-Datenbank hinzu
gcode:
    {% set id = params.ID|int %}
    {% set name = params.NAME|default("Endmill " ~ id) %}
    {% set diameter = params.DIAMETER|float %}
    {% set length = params.LENGTH|float %}
    {% set flutes = params.FLUTES|default(2)|int %}
    {% set flute_length = params.FLUTE_LENGTH|default(diameter * 3)|float %}
    {% set max_rpm = params.MAX_RPM|default(12000)|int %}
    {% set feedrate = params.FEEDRATE|default(500)|float %}
    {% set plunge_rate = params.PLUNGE_RATE|default(150)|float %}
    
    ADD_TOOL ID={id} NAME="{name}" TYPE=endmill DIAMETER={diameter} LENGTH={length} FLUTE_LENGTH={flute_length} MAX_RPM={max_rpm} FEEDRATE={feedrate} PLUNGE_RATE={plunge_rate} DESCRIPTION="Flutes: {flutes}"

[gcode_macro ADD_BALLNOSE]
description: Füge einen Kugelfräser zur Tool-Datenbank hinzu
gcode:
    {% set id = params.ID|int %}
    {% set name = params.NAME|default("Ball Nose " ~ id) %}
    {% set diameter = params.DIAMETER|float %}
    {% set length = params.LENGTH|float %}
    {% set radius = diameter / 2 %}
    {% set max_rpm = params.MAX_RPM|default(15000)|int %}
    {% set feedrate = params.FEEDRATE|default(800)|float %}
    {% set stepover = params.STEPOVER|default(0.1 * diameter)|float %}
    
    ADD_TOOL ID={id} NAME="{name}" TYPE=ballnose DIAMETER={diameter} LENGTH={length} MAX_RPM={max_rpm} FEEDRATE={feedrate} DESCRIPTION="Radius: {radius}mm, Stepover: {stepover}mm"

[gcode_macro ADD_VBIT]
description: Füge einen V-Bit zur Tool-Datenbank hinzu
gcode:
    {% set id = params.ID|int %}
    {% set name = params.NAME|default("V-Bit " ~ id) %}
    {% set angle = params.ANGLE|float %}
    {% set tip_diameter = params.TIP_DIAMETER|default(0.1)|float %}
    {% set length = params.LENGTH|float %}
    {% set max_rpm = params.MAX_RPM|default(18000)|int %}
    {% set feedrate = params.FEEDRATE|default(600)|float %}
    
    ADD_TOOL ID={id} NAME="{name}" TYPE=vbit DIAMETER={tip_diameter} LENGTH={length} ANGLE={angle} MAX_RPM={max_rpm} FEEDRATE={feedrate} DESCRIPTION="V-angle: {angle}°"

[gcode_macro ADD_LASER]
description: Füge einen Laser zur Tool-Datenbank hinzu
gcode:
    {% set id = params.ID|int %}
    {% set name = params.NAME|default("Laser " ~ id) %}
    {% set power = params.POWER|default(5)|float %}
    {% set wavelength = params.WAVELENGTH|default(445)|int %}
    {% set spot_size = params.SPOT_SIZE|default(0.1)|float %}
    {% set focal_length = params.FOCAL_LENGTH|default(50)|float %}
    
    ADD_TOOL ID={id} NAME="{name}" TYPE=laser DIAMETER={spot_size} LENGTH={focal_length} DESCRIPTION="Power: {power}W, Wavelength: {wavelength}nm"

[gcode_macro ADD_PLANER]
description: Füge einen Planer/Surfacing Tool zur Tool-Datenbank hinzu
gcode:
    {% set id = params.ID|int %}
    {% set name = params.NAME|default("Planer " ~ id) %}
    {% set diameter = params.DIAMETER|float %}
    {% set length = params.LENGTH|float %}
    {% set max_rpm = params.MAX_RPM|default(8000)|int %}
    {% set feedrate = params.FEEDRATE|default(1500)|float %}
    {% set stepover = params.STEPOVER|default(0.8 * diameter)|float %}
    
    ADD_TOOL ID={id} NAME="{name}" TYPE=planer DIAMETER={diameter} LENGTH={length} MAX_RPM={max_rpm} FEEDRATE={feedrate} DESCRIPTION="Stepover: {stepover}mm"

#####################################################################
# TOOL CHANGE MACROS
#####################################################################

[gcode_macro TOOL_CHANGE]
description: Vollständiger Tool-Wechsel mit Sicherheitsprotokoll
gcode:
    {% set id = params.ID|int %}
    
    RESPOND MSG="=== Starting Tool Change to T{id} ==="
    
    # Stoppe Spindel
    M5
    
    # Fahre in sichere Position
    G53 G0 Z0  # Absolute Z-max
    G53 G0 X0 Y0  # Parkposition
    
    # Warte auf Bestätigung (optional)
    {% if params.MANUAL|default(0)|int == 1 %}
        M0  # Pause für manuellen Wechsel
    {% endif %}
    
    # Wähle neues Tool
    SELECT_TOOL ID={id}
    
    # Tool-Längenmessung (optional)
    {% if params.PROBE|default(0)|int == 1 %}
        PROBE_TOOL_LENGTH
    {% endif %}
    
    RESPOND MSG="Tool change complete"

[gcode_macro PROBE_TOOL_LENGTH]
description: Messe Tool-Länge mit Touch-Probe
gcode:
    RESPOND MSG="Probing tool length..."
    
    # Sichere aktuelle Position
    SAVE_GCODE_STATE NAME=tool_probe_state
    
    # Fahre zu Probe-Position
    G53 G0 X{printer.configfile.settings.tool_probe.x} Y{printer.configfile.settings.tool_probe.y}
    G53 G0 Z{printer.configfile.settings.tool_probe.z + 10}
    
    # Probe Z-Achse
    G38.2 Z{printer.configfile.settings.tool_probe.z - 50} F100
    
    # Berechne und setze Offset
    {% set probe_z = printer.gcode_move.gcode_position.z %}
    {% set tool_length = printer.configfile.settings.tool_probe.z - probe_z %}
    
    RESPOND MSG="Tool length: {tool_length}mm"
    
    # Fahre zurück
    G91
    G0 Z5
    G90
    
    RESTORE_GCODE_STATE NAME=tool_probe_state

[gcode_macro SAFE_TOOL_CHANGE]
description: Tool-Wechsel mit vollständiger Sicherheitsprüfung
gcode:
    {% set id = params.ID|int %}
    
    # Prüfe ob Job läuft
    {% if printer.idle_timeout.state == "Printing" %}
        # Pausiere Job
        PAUSE
    {% endif %}
    
    # Deaktiviere Tool-Monitoring während Wechsel
    STOP_TOOL_MONITORING
    
    # Führe Wechsel durch
    TOOL_CHANGE ID={id} MANUAL={params.MANUAL|default(1)}
    
    # Reaktiviere Monitoring
    START_TOOL_MONITORING
    CALIBRATE_TOOL_BASELINE
    RESET_COLLISION_DETECTION

#####################################################################
# TOOL MAINTENANCE MACROS
#####################################################################

[gcode_macro CHECK_TOOL_CONDITION]
description: Prüfe aktuellen Tool-Zustand
gcode:
    TOOL_INFO
    TOOL_MONITORING_STATUS
    
    # Prüfe auch Probe-basierte Verschleißmessung
    {% if printer.configfile.settings.tool_monitoring.enable_probe_wear_detection|default(False) %}
        CHECK_TOOL_WEAR_PROBE
    {% endif %}

[gcode_macro MARK_TOOL_FOR_REPLACEMENT]
description: Markiere Tool als defekt/verschlissen
gcode:
    {% set id = params.ID|int %}
    UPDATE_TOOL ID={id} IS_ACTIVE=0
    RESPOND MSG="Tool {id} marked for replacement"

[gcode_macro RESET_TOOL_WEAR]
description: Reset Verschleißzähler nach Wartung/Ersatz
gcode:
    {% set id = params.ID|int %}
    RESET_TOOL_STATS ID={id}
    UPDATE_TOOL ID={id} IS_ACTIVE=1
    RESPOND MSG="Tool {id} wear reset, marked as active"

[gcode_macro QUICK_TOOL_CHECK]
description: Schnelle Übersicht über alle Tools
gcode:
    LIST_TOOLS
    RESPOND MSG=""
    TOOL_MONITORING_STATUS

#####################################################################
# ADVANCED TOOL OPERATIONS
#####################################################################

[gcode_macro AUTO_TOOL_SELECT]
description: Automatische Tool-Auswahl basierend auf Job-Anforderungen
gcode:
    {% set operation = params.OPERATION|default("milling") %}
    {% set material = params.MATERIAL|default("wood") %}
    {% set diameter = params.DIAMETER|default(6)|float %}
    
    RESPOND MSG="Auto-selecting tool for {operation} on {material}..."
    
    # Hier könnte intelligente Logik zur Tool-Auswahl implementiert werden
    # Vorerst einfache Beispiel-Logik
    
    {% if operation == "drilling" %}
        # Finde passenden Bohrer
        LIST_TOOLS TYPE=drill
    {% elif operation == "finishing" %}
        # Finde Kugelfräser
        LIST_TOOLS TYPE=ballnose
    {% elif operation == "engraving" %}
        # Finde V-Bit
        LIST_TOOLS TYPE=vbit
    {% elif operation == "surfacing" %}
        # Finde Planer
        LIST_TOOLS TYPE=planer
    {% else %}
        # Standard Schaftfräser
        LIST_TOOLS TYPE=endmill
    {% endif %}

[gcode_macro TOOL_WARMUP]
description: Spindel-Warmup für neues Tool
gcode:
    {% set rpm = params.RPM|default(5000)|int %}
    {% set duration = params.DURATION|default(30)|int %}
    
    RESPOND MSG="Starting spindle warmup at {rpm} RPM for {duration}s..."
    
    # Starte Spindel mit niedriger Drehzahl
    M3 S{rpm * 0.3}
    G4 P5000  # 5 Sekunden
    
    # Erhöhe auf Zieldrehzahl
    M3 S{rpm}
    G4 P{duration * 1000}
    
    # Stoppe Spindel
    M5
    
    RESPOND MSG="Warmup complete"

[gcode_macro TOOL_COOLDOWN]
description: Kontrolliertes Herunterfahren der Spindel
gcode:
    {% set current_rpm = printer.spindle_control.speed|default(0) %}
    
    {% if current_rpm > 0 %}
        RESPOND MSG="Cooling down spindle from {current_rpm} RPM..."
        
        # Stufenweises Reduzieren
        M3 S{current_rpm * 0.7}
        G4 P3000
        
        M3 S{current_rpm * 0.4}
        G4 P2000
        
        M3 S{current_rpm * 0.2}
        G4 P1000
        
        # Stoppe
        M5
        RESPOND MSG="Spindle stopped"
    {% else %}
        RESPOND MSG="Spindle already stopped"
    {% endif %}

#####################################################################
# BATCH OPERATIONS
#####################################################################

[gcode_macro SETUP_DEFAULT_TOOLS]
description: Lade Standard-Tool-Bibliothek
gcode:
    RESPOND MSG="Setting up default tool library..."
    
    # Standard Bohrer
    ADD_DRILL ID=1 NAME="3mm Drill" DIAMETER=3.0 LENGTH=50 MAX_RPM=8000
    ADD_DRILL ID=2 NAME="6mm Drill" DIAMETER=6.0 LENGTH=60 MAX_RPM=6000
    
    # Standard Schaftfräser
    ADD_ENDMILL ID=10 NAME="3mm 2-Flute" DIAMETER=3.0 LENGTH=50 FLUTES=2
    ADD_ENDMILL ID=11 NAME="6mm 4-Flute" DIAMETER=6.0 LENGTH=60 FLUTES=4
    
    # Kugelfräser
    ADD_BALLNOSE ID=20 NAME="3mm Ball" DIAMETER=3.0 LENGTH=50
    ADD_BALLNOSE ID=21 NAME="6mm Ball" DIAMETER=6.0 LENGTH=60
    
    # V-Bits
    ADD_VBIT ID=30 NAME="30° V-Bit" ANGLE=30 LENGTH=40
    ADD_VBIT ID=31 NAME="60° V-Bit" ANGLE=60 LENGTH=40
    ADD_VBIT ID=32 NAME="90° V-Bit" ANGLE=90 LENGTH=40
    
    # Planer
    ADD_PLANER ID=40 NAME="50mm Surfacing" DIAMETER=50 LENGTH=30
    
    # Laser (falls vorhanden)
    ADD_LASER ID=50 NAME="5W Blue Laser" POWER=5 WAVELENGTH=445
    
    RESPOND MSG="Default tool library loaded"
    LIST_TOOLS

[gcode_macro BACKUP_TOOL_DATABASE]
description: Erstelle Backup der Tool-Datenbank
gcode:
    {% set timestamp = params.TIMESTAMP|default("backup")|string %}
    EXPORT_TOOLS FILENAME="tools_backup_{timestamp}.json"
    RESPOND MSG="Tool database backed up"

[gcode_macro RESTORE_TOOL_DATABASE]
description: Stelle Tool-Datenbank aus Backup wieder her
gcode:
    {% set filename = params.FILENAME %}
    IMPORT_TOOLS FILENAME="{filename}" OVERWRITE=1
    RESPOND MSG="Tool database restored from {filename}"

#####################################################################
# MONITORING SHORTCUTS
#####################################################################

[gcode_macro START_JOB_MONITORING]
description: Starte komplette Überwachung für Job
gcode:
    START_TOOL_MONITORING
    CALIBRATE_TOOL_BASELINE
    RESET_COLLISION_DETECTION
    RESPOND MSG="Job monitoring active"

[gcode_macro STOP_JOB_MONITORING]
description: Stoppe Job-Überwachung
gcode:
    STOP_TOOL_MONITORING
    RESPOND MSG="Job monitoring stopped"

[gcode_macro EMERGENCY_TOOL_STOP]
description: Notfall-Stop bei Tool-Problem
gcode:
    M5  # Spindel stop
    M2  # Programm Ende
    RESPOND MSG="!!! EMERGENCY TOOL STOP !!!"

#####################################################################
# PROBE-BASIERTE VERSCHLEISSERKENNUNG
#####################################################################

[gcode_macro MEASURE_TOOL_WEAR]
description: Messe Werkzeuglänge zur Verschleißerkennung
gcode:
    {% set tool_id = params.TOOL_ID|default(None) %}
    
    RESPOND MSG="Measuring tool length for wear detection..."
    
    # Stoppe Spindel falls aktiv
    M5
    
    # Warte kurz
    G4 P1000
    
    # Führe Längenmessung durch
    {% if tool_id %}
        MEASURE_TOOL_LENGTH TOOL_ID={tool_id}
    {% else %}
        MEASURE_TOOL_LENGTH
    {% endif %}
    
    RESPOND MSG="Tool length measurement complete"

[gcode_macro AUTO_TOOL_WEAR_CHECK]
description: Automatische Verschleißprüfung vor Job-Start
gcode:
    {% set tool_id = params.TOOL_ID|int %}
    
    RESPOND MSG="=== Automatic Tool Wear Check ==="
    
    # Wähle Tool
    SELECT_TOOL ID={tool_id}
    
    # Messe Länge
    MEASURE_TOOL_WEAR TOOL_ID={tool_id}
    
    # Zeige Verschleißstatus
    CHECK_TOOL_WEAR_PROBE TOOL_ID={tool_id}
    
    RESPOND MSG="Wear check complete, ready to start job"

[gcode_macro BASELINE_TOOL_MEASUREMENT]
description: Erste Längenmessung für neues/geschärftes Tool
gcode:
    {% set tool_id = params.TOOL_ID|int %}
    
    RESPOND MSG="=== Baseline Tool Measurement ==="
    RESPOND MSG="This will be the reference for wear detection"
    
    # Wähle Tool
    SELECT_TOOL ID={tool_id}
    
    # Erste Messung (wird als Original gespeichert)
    MEASURE_TOOL_WEAR TOOL_ID={tool_id}
    
    RESPOND MSG="Baseline established for Tool {tool_id}"

[gcode_macro TOOL_WEAR_REPORT]
description: Vollständiger Verschleißbericht aller Tools
gcode:
    RESPOND MSG="=== Complete Tool Wear Report ==="
    
    # Statistische Verschleißdaten
    LIST_TOOLS
    
    RESPOND MSG=""
    RESPOND MSG="=== Probe-Based Wear Measurements ==="
    
    # Probe-Messungen
    CHECK_TOOL_WEAR_PROBE
    
    RESPOND MSG=""
    RESPOND MSG="=== Monitoring Statistics ==="
    TOOL_MONITORING_STATUS

[gcode_macro SAFE_TOOL_CHANGE_WITH_CHECK]
description: Tool-Wechsel mit automatischer Verschleißprüfung
gcode:
    {% set id = params.ID|int %}
    {% set check_wear = params.CHECK_WEAR|default(1)|int %}
    
    RESPOND MSG="=== Tool Change with Wear Check ==="
    
    # Normaler Tool-Wechsel
    SAFE_TOOL_CHANGE ID={id}
    
    # Optional: Verschleißprüfung
    {% if check_wear == 1 %}
        RESPOND MSG="Performing wear check..."
        MEASURE_TOOL_WEAR TOOL_ID={id}
    {% endif %}
    
    RESPOND MSG="Tool change complete"
