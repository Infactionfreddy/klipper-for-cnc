# Example CNC Tool Database Configuration
# 
# Diese Konfiguration zeigt, wie die Tool-Datenbank und
# Tool-Überwachung in Ihre CNC-Konfiguration integriert werden

#####################################################################
# TOOL DATABASE MODUL
#####################################################################

[tool_database]
# Verzeichnis für Tool-Datenbank (wird automatisch erstellt)
data_dir: ~/printer_data/tools
# Die Datenbank wird automatisch als tool_database.json gespeichert

#####################################################################
# TOOL MONITORING MODUL
#####################################################################

[tool_monitoring]
# Kollisionserkennung aktivieren
enable_collision_detection: True
# Verschleißüberwachung aktivieren
enable_wear_monitoring: True
# Werkzeugbruch-Erkennung aktivieren
enable_break_detection: True

# Kollisions-Schwellwerte
# Beschleunigungsschwelle für Kollisionserkennung (mm/s²)
collision_acceleration_threshold: 5000.0
# Kraftschwelle (für zukünftige Sensoren)
collision_force_threshold: 50.0

# Verschleiß-Parameter
# Intervall für Verschleißprüfung (Sekunden)
wear_check_interval: 60.0
# Vibrations-Schwelle für Verschleißerkennung
wear_vibration_threshold: 2.0

# Probe-basierte Verschleißerkennung
# Misst Werkzeuglänge mit Touch-Probe zur Verschleißerkennung
enable_probe_wear_detection: True
# Schwellwert für Längenverschleiß in mm
probe_wear_threshold: 0.5
# Messe Werkzeuglänge alle X Jobs
probe_wear_check_frequency: 5

# Werkzeugbruch-Parameter
# Empfindlichkeit der Brucherkennung (0.0-1.0)
break_detection_sensitivity: 0.8
# Schwelle für Spindelstrom bei Bruch (Verhältnis zur Baseline)
break_spindle_current_threshold: 0.5

# Aktionen bei Erkennung
# Optionen: pause, stop, continue
action_on_collision: pause
# Optionen: pause, stop
action_on_break: stop

#####################################################################
# WERKSTÜCK-PROBE (G38.2 - Standard Probe für Werkstücke)
#####################################################################

[probe]
# Pin für Werkstück-Probe (SEPARATER PIN vom Tool Length Probe!)
pin: ^!P1.27  # Beispiel-Pin, anpassen!
x_offset: 0
y_offset: 0
z_offset: 0
speed: 5.0
samples: 3
sample_retract_dist: 2.0
samples_result: average
samples_tolerance: 0.01
samples_tolerance_retries: 3

#####################################################################
# TOOL LENGTH PROBE (Dedizierter Sensor für Werkzeuglängenmessung)
#####################################################################

[tool_length_probe]
# Pin für Tool Length Probe (SEPARATER PIN vom Werkstück-Probe!)
pin: ^!P1.28  # Beispiel-Pin, anpassen!

# Position des fest montierten Tool-Length-Sensors auf dem Tisch
x: 100  # X-Position des Sensors
y: 100  # Y-Position des Sensors
z: 0    # Z-Höhe der Sensor-Oberfläche (absolut)

# Messgeschwindigkeit
speed: 5.0
lift_speed: 10.0

# Sampling-Parameter für höchste Genauigkeit
samples: 3
sample_retract_dist: 2.0
samples_result: average
samples_tolerance: 0.01
samples_tolerance_retries: 3

# Maximum Probe-Distanz (Sicherheit)
max_probe_distance: 50.0

#####################################################################
# INCLUDE TOOL MACROS
#####################################################################

[include tool-macros.cfg]

#####################################################################
# BEISPIEL PRINTER KONFIGURATION MIT TOOLS
#####################################################################

# Fügen Sie diese Sektion zu Ihrer printer.cfg hinzu:
#
# [printer]
# kinematics: cartesian
# max_velocity: 300
# max_accel: 3000
# max_z_velocity: 15
# max_z_accel: 100
#
# [stepper_x]
# step_pin: PF0
# dir_pin: PF1
# enable_pin: !PD7
# microsteps: 16
# rotation_distance: 40
# endstop_pin: ^PE5
# position_endstop: 0
# position_max: 500
# homing_speed: 50
#
# [stepper_y]
# step_pin: PF6
# dir_pin: PF7
# enable_pin: !PF2
# microsteps: 16
# rotation_distance: 40
# endstop_pin: ^PJ1
# position_endstop: 0
# position_max: 500
# homing_speed: 50
#
# [stepper_z]
# step_pin: PL3
# dir_pin: PL1
# enable_pin: !PK0
# microsteps: 16
# rotation_distance: 8
# endstop_pin: ^PD3
# position_endstop: 0.5
# position_max: 200
# homing_speed: 10
#
# [spindle_control]
# pwm_pin: PE5
# enable_pin: PE4
# direction_pin: PE3
# min_rpm: 0
# max_rpm: 24000
# pwm_cycle_time: 0.001

#####################################################################
# BEISPIEL: STARTUP-SEQUENZ MIT TOOL-MANAGEMENT
#####################################################################

[gcode_macro CNC_STARTUP]
description: CNC Startup Sequenz mit Tool-Management
gcode:
    # Home alle Achsen
    G28
    
    # Lade Tool-Datenbank (falls noch nicht geladen)
    RESPOND MSG="Loading tool database..."
    
    # Starte Tool-Monitoring
    START_TOOL_MONITORING
    
    # Zeige verfügbare Tools
    LIST_TOOLS
    
    # Zeige aktuelles Tool
    {% if printer.tool_database.current_tool %}
        RESPOND MSG="Current tool: T{printer.tool_database.current_tool.id}"
        TOOL_INFO
    {% else %}
        RESPOND MSG="No tool selected"
    {% endif %}
    
    RESPOND MSG="CNC ready for operation"

[gcode_macro CNC_SHUTDOWN]
description: CNC Shutdown Sequenz
gcode:
    # Stoppe Spindel
    M5
    
    # Stoppe Monitoring
    STOP_TOOL_MONITORING
    
    # Fahre in Parkposition
    G53 G0 Z0
    G53 G0 X0 Y0
    
    # Backup Tool-Datenbank
    BACKUP_TOOL_DATABASE TIMESTAMP={printer.system_stats.cputime|int}
    
    RESPOND MSG="CNC shutdown complete"

#####################################################################
# BEISPIEL: KOMPLETTES CNC-PROJEKT MIT TOOLS
#####################################################################

[gcode_macro EXAMPLE_CNC_JOB]
description: Beispiel für ein komplettes CNC-Projekt mit Tool-Wechsel
gcode:
    RESPOND MSG="=== Starting Example CNC Job ==="
    
    # Starte Monitoring
    START_JOB_MONITORING
    
    # Schritt 1: Oberflächenbearbeitung mit Planer
    RESPOND MSG="Step 1: Surfacing with planer..."
    SAFE_TOOL_CHANGE ID=40  # Planer
    M3 S8000  # Spindel Start
    G0 X10 Y10 Z5
    # ... Ihr G-Code für Surfacing ...
    M5  # Spindel Stop
    
    # Schritt 2: Fräsen mit Schaftfräser
    RESPOND MSG="Step 2: Milling with endmill..."
    SAFE_TOOL_CHANGE ID=11  # 6mm Endmill
    M3 S12000
    G0 X50 Y50 Z5
    # ... Ihr G-Code für Fräsen ...
    M5
    
    # Schritt 3: Bohren
    RESPOND MSG="Step 3: Drilling holes..."
    SAFE_TOOL_CHANGE ID=2  # 6mm Drill
    M3 S6000
    # ... Ihr G-Code für Bohren ...
    M5
    
    # Schritt 4: Finishing mit Kugelfräser
    RESPOND MSG="Step 4: Finishing with ball nose..."
    SAFE_TOOL_CHANGE ID=21  # 6mm Ball
    M3 S15000
    # ... Ihr G-Code für Finishing ...
    M5
    
    # Stoppe Monitoring
    STOP_JOB_MONITORING
    
    # Fahre in Parkposition
    G53 G0 Z0
    G53 G0 X0 Y0
    
    RESPOND MSG="=== Job Complete ==="
    
    # Zeige Tool-Statistiken
    QUICK_TOOL_CHECK

#####################################################################
# BEISPIEL: WERKZEUG-LEBENSDAUER-VERWALTUNG
#####################################################################

[gcode_macro CHECK_TOOL_LIFE]
description: Überprüfe alle Tools auf Lebensdauer
gcode:
    RESPOND MSG="=== Tool Life Check ==="
    
    # Diese Funktion würde alle Tools durchgehen und
    # Warnungen für verschlissene Tools ausgeben
    
    LIST_TOOLS
    
    # Beispiel für spezifische Tool-Checks
    # (In Python-Modul würde dies automatisch geschehen)
    
    RESPOND MSG="Check tool_database.json for detailed wear information"

#####################################################################
# WARTUNGS-HINWEISE
#####################################################################

# Die Tool-Datenbank speichert automatisch:
# - Tool-Parameter (Länge, Durchmesser, Offsets)
# - Nutzungsstatistiken (Laufzeit, Distanz, Zyklen)
# - Verschleißlevel (0-100%)
# - Letzte Verwendung
# - Aktiv/Inaktiv Status
#
# Daten werden gespeichert in:
# ~/printer_data/tools/tool_database.json
#
# Backup erstellen:
# BACKUP_TOOL_DATABASE
#
# Backup wiederherstellen:
# RESTORE_TOOL_DATABASE FILENAME="tools_backup_xxxxx.json"
#
# Tool-Statistiken zurücksetzen nach Wartung:
# RESET_TOOL_WEAR ID=<tool_id>
#
# Tool als defekt markieren:
# MARK_TOOL_FOR_REPLACEMENT ID=<tool_id>

#####################################################################
# MOONRAKER INTEGRATION
#####################################################################

# Die Tool-Datenbank und Monitoring sind über die Moonraker API
# verfügbar unter:
#
# GET /printer/objects/query?tool_database
# GET /printer/objects/query?tool_monitoring
#
# Beispiel API Responses:
#
# tool_database:
#   tool_count: 8
#   current_tool:
#     id: 11
#     name: "6mm 4-Flute"
#     type: "endmill"
#     diameter: 6.0
#     length: 60.0
#     wear_level: 35.2
#   tools: [...]
#
# tool_monitoring:
#   monitoring_active: true
#   collision_detected: false
#   break_detected: false
#   wear_alert: false
#   collision_count: 0
#   baseline_current: 2.5
#   current_current: 2.3
#   vibration_level: 0.8
