# ===================================================================
# CNC Program Control - Example Configuration
# ===================================================================
# Aktiviert M0, M1, M2, M30 Befehle für Standard-konforme CNC-Steuerung
# Basiert auf: LinuxCNC M-Code Standard
# https://linuxcnc.org/docs/devel/html/de/gcode/m-code.html
# ===================================================================

# ===================================================================
# M0, M1, M2, M30 - Program Control
# ===================================================================
[cnc_program_control]
# Aktiviert:
# - M0:  Program Pause (bedingungslos)
# - M1:  Optional Program Pause
# - M2:  Program End
# - M30: Program End with Reset

# ===================================================================
# PAUSE/RESUME - Erforderlich für M0/M1
# ===================================================================
[pause_resume]
# Benötigt für M0/M1 Funktionalität
recover_velocity: 50

# ===================================================================
# Optional: Spindel-Steuerung (M3/M4/M5)
# ===================================================================
# Wird von M2/M30 automatisch aufgerufen (M5 - Spindel stopp)

[output_pin spindle_pwm]
pin: PA8                # GPIO Pin für Spindel (PWM)
pwm: True
hardware_pwm: False
value: 0
shutdown_value: 0
cycle_time: 0.001       # 1kHz PWM

[gcode_macro M3]
description: Spindle ON (Clockwise)
gcode:
    {% set S = params.S|default(12000)|float %}
    {% set MAX_RPM = 24000.0 %}
    {% set PWM = (S / MAX_RPM)|float %}
    SET_PIN PIN=spindle_pwm VALUE={PWM}
    {action_respond_info("Spindle CW: %.0f RPM (PWM: %.2f)" % (S, PWM))}

[gcode_macro M4]
description: Spindle ON (Counter-Clockwise)
gcode:
    # Wenn Richtungspin vorhanden:
    # SET_PIN PIN=spindle_dir VALUE=1
    M3 {rawparams}  # Dann wie M3
    {action_respond_info("Spindle CCW: %s" % (params.S|default(12000)))}

[gcode_macro M5]
description: Spindle STOP
gcode:
    SET_PIN PIN=spindle_pwm VALUE=0
    {action_respond_info("Spindle stopped")}

# ===================================================================
# Optional: Kühlmittel-Steuerung (M7/M8/M9)
# ===================================================================
# Wird von M2/M30 automatisch aufgerufen (M9 - Kühlmittel aus)

[output_pin coolant_flood]
pin: PB3                # GPIO Pin für Kühlmittel
value: 0
shutdown_value: 0

[gcode_macro M7]
description: Coolant Mist ON
gcode:
    # Nebel-Kühlmittel (falls separater Pin)
    {action_respond_info("Coolant mist ON")}
    # SET_PIN PIN=coolant_mist VALUE=1

[gcode_macro M8]
description: Coolant Flood ON
gcode:
    SET_PIN PIN=coolant_flood VALUE=1
    {action_respond_info("Coolant flood ON")}

[gcode_macro M9]
description: Coolant OFF
gcode:
    SET_PIN PIN=coolant_flood VALUE=0
    # SET_PIN PIN=coolant_mist VALUE=0
    {action_respond_info("All coolant OFF")}

# ===================================================================
# Optional Stop Steuerung
# ===================================================================
# M1 Optional Pause kann über Makro ein/ausgeschaltet werden

[gcode_macro ENABLE_OPTIONAL_STOP]
description: Enable M1 optional stop
gcode:
    SET_OPTIONAL_STOP ENABLE=1
    {action_respond_info("Optional stop (M1) ENABLED")}

[gcode_macro DISABLE_OPTIONAL_STOP]
description: Disable M1 optional stop
gcode:
    SET_OPTIONAL_STOP ENABLE=0
    {action_respond_info("Optional stop (M1) DISABLED")}

# ===================================================================
# Beispiel: CNC Job Workflow
# ===================================================================
# [gcode_macro START_CNC_JOB]
# gcode:
#     G28                      ; Home all axes
#     M211 S1                  ; Enable software limits
#     G54                      ; Work coordinate system
#     M3 S12000                ; Spindle on
#     M8                       ; Coolant on
#     {action_respond_info("CNC job started")}
#
# [gcode_macro END_CNC_JOB]
# gcode:
#     M5                       ; Spindle off
#     M9                       ; Coolant off
#     G28                      ; Return home
#     M211 S1                  ; Re-enable limits
#     {action_respond_info("CNC job completed")}

# ===================================================================
# Test-Sequenz
# ===================================================================
# G28               ; Home
# M211 S1           ; Software limits aktivieren
# G1 X50 F3000      ; Bewegung
# M0                ; Pause - warte auf RESUME
# G1 Y50
# M1                ; Optional pause (wenn aktiviert)
# M2                ; Programmende (oder M30 für Wiederholung)

# ===================================================================
# Sicherheits-Hinweise
# ===================================================================
# 1. M112: Emergency Stop - funktioniert IMMER (auch ohne diese Config)
# 2. M211 S1: Software Limits immer aktiviert lassen
# 3. M211 S0: NUR verwenden wenn absolut notwendig (z.B. Homing)
# 4. M0/M1: Heater bleiben aktiv während Pause
# 5. M2/M30: Spindel/Kühlmittel werden automatisch gestoppt

# ===================================================================
# Referenzen
# ===================================================================
# LinuxCNC M-Code:  https://linuxcnc.org/docs/devel/html/de/gcode/m-code.html
# ISO 6983:         https://www.zintilon.com/de/blog/what-is-m-code/
# Klipper Docs:     https://www.klipper3d.org/Config_Reference.html
